<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PESADA - Exibição</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#123;margin:0;color:#fff;display:flex;flex-direction:column;align-items:center;min-height:100vh}
  header{width:100%;padding:18px 12px;text-align:center;background:linear-gradient(90deg,#32cd32,#ffa500,#123);box-shadow:0 4px 10px rgba(0,0,0,.25)}
  .logo{width:200px}
  .button-full{padding:10px 18px;background:#fff;color:#123;border:none;border-radius:8px;cursor:pointer;font-size:16px;margin-top:8px}
  .button-full:hover{background:#32cd32;color:#fff}
  .container{max-width:1400px;width:100%;padding:14px}
  .report-container{position:relative;border-radius:12px;overflow:hidden;background:#000;height:600px;width:100%}
  /* fullscreen: quando o elemento entra em fullscreen, faça-o ocupar a tela toda */
  .report-container:fullscreen,
  .report-container:-webkit-full-screen,
  .report-container:-ms-fullscreen {
    height:100vh;
    width:100vw;
    border-radius:0;
  }
  .image-container{position:relative;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center}
  .image-container img{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:100%;max-height:100%;object-fit:contain;opacity:0;transition:opacity .9s ease}
  .image-container img.active{opacity:1}
  .controls{margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:center}
  .btn{background:#fff;color:#000;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .status{color:#fff;margin-left:12px;font-size:14px}
  /* mensagem quando sem imagens */
  .empty-msg{display:flex;align-items:center;justify-content:center;height:100%;color:#fff;font-size:20px}
</style>
</head>
<body>

<header>
  <img class="logo" src="img/logo.png" alt="" />
  <h1>Equipes Pesadas — Exibição</h1>
  <p>Unidade Rio Verde - Grupo Partnership</p>
  <button class="button-full" id="fullscreenBtn">TELA CHEIA</button>
</header>

<div class="container">
  <div class="report-container" id="reportContainer">
    <div class="image-container" id="slideshow"></div>
  </div>

  <div class="controls">
    <button class="btn" id="prevBtn">◀</button>
    <button class="btn" id="pauseBtn">Pausar</button>
    <button class="btn" id="nextBtn">▶</button>
    <div class="status" id="status">Carregando...</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBehqlRiCiDniyPi3bjHtkH7q2-Px-KoZc",
    authDomain: "cadastr-produtos-clevir.firebaseapp.com",
    databaseURL: "https://cadastr-produtos-clevir-default-rtdb.firebaseio.com",
    projectId: "cadastr-produtos-clevir",
    storageBucket: "cadastr-produtos-clevir.firebasestorage.app",
    messagingSenderId: "1028296092810",
    appId: "1:1028296092810:web:86859328b19c1fdf511173",
    measurementId: "G-JGE4Q09NX8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const DB_NODE = "RELATORIOS-PESADAS-PRTNRV";

  const slideshowEl = document.getElementById("slideshow");
  const statusEl = document.getElementById("status");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const fullscreenBtn = document.getElementById("fullscreenBtn");
  const reportContainer = document.getElementById("reportContainer");

  let images = []; // array de { key, url, createdAt }
  let index = 0;
  let tempo = 5000;
  let timer = null;
  let paused = false;

  // monta os slides no DOM (após atualizar images[])
  function renderSlides() {
    // limpar
    slideshowEl.innerHTML = "";

    if (!images.length) {
      slideshowEl.innerHTML = '<div class="empty-msg">Nenhuma imagem cadastrada</div>';
      statusEl.textContent = "Sem imagens";
      return;
    }

    // adicionar imgs
    images.forEach((it, i) => {
      const img = document.createElement("img");
      img.src = it.url || it; // compatibilidade com string ou objeto
      img.dataset.key = it.key || "";
      if (i === index) img.classList.add("active");
      slideshowEl.appendChild(img);
    });

    statusEl.textContent = `Imagem ${index + 1} / ${images.length} • Tempo: ${tempo} ms`;

    // reinicia loop
    restartTimer();
  }

  function restartTimer() {
    if (timer) { clearTimeout(timer); timer = null; }
    if (paused) return;
    if (!images.length) return;
    timer = setTimeout(() => {
      nextImage();
      restartTimer();
    }, tempo);
  }

  function nextImage() {
    const imgs = slideshowEl.querySelectorAll("img");
    if (!imgs.length) return;
    imgs[index].classList.remove("active");
    index = (index + 1) % imgs.length;
    imgs[index].classList.add("active");
    statusEl.textContent = `Imagem ${index + 1} / ${imgs.length} • Tempo: ${tempo} ms`;
  }

  function prevImage() {
    const imgs = slideshowEl.querySelectorAll("img");
    if (!imgs.length) return;
    imgs[index].classList.remove("active");
    index = (index - 1 + imgs.length) % imgs.length;
    imgs[index].classList.add("active");
    statusEl.textContent = `Imagem ${index + 1} / ${imgs.length} • Tempo: ${tempo} ms`;
  }

  prevBtn.addEventListener("click", () => { prevImage(); restartTimer(); });
  nextBtn.addEventListener("click", () => { nextImage(); restartTimer(); });
  pauseBtn.addEventListener("click", () => {
    paused = !paused;
    pauseBtn.textContent = paused ? "Retomar" : "Pausar";
    if (paused) { if (timer) { clearTimeout(timer); timer = null; } }
    else restartTimer();
  });

  // Fullscreen toggle (aplica ao reportContainer)
  fullscreenBtn.addEventListener("click", () => {
    if (!document.fullscreenElement) {
      if (reportContainer.requestFullscreen) reportContainer.requestFullscreen();
      else if (reportContainer.webkitRequestFullscreen) reportContainer.webkitRequestFullscreen();
      else if (reportContainer.msRequestFullscreen) reportContainer.msRequestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
    }
  });

  // Ouvir mudanças no Firebase em tempo real
  const rootRef = ref(db, DB_NODE);
  onValue(rootRef, (snap) => {
    const data = snap.val() || {};
    // ler tempo (se existir e for número)
    if (data.tempo && !isNaN(parseInt(data.tempo))) tempo = parseInt(data.tempo);
    else tempo = 5000;

    // imagens: pode ser objeto { key: {url, ...}, ... } ou array/string
    const imgsObj = data.imagens || {};
    if (!imgsObj || (typeof imgsObj === "object" && Object.keys(imgsObj).length === 0)) {
      images = [];
      index = 0;
      renderSlides();
      return;
    }

    // transformar em array padronizado [{key,url,createdAt}, ...]
    if (Array.isArray(imgsObj)) {
      images = imgsObj.map((v,i) => ({ key: i, url: (v && v.url) ? v.url : v, createdAt: v?.createdAt || 0 }));
    } else {
      images = Object.entries(imgsObj).map(([k,v]) => ({ key: k, url: (v && v.url) ? v.url : v, createdAt: v?.createdAt || 0 }));
    }

    // ordenar por createdAt desc (novas primeiro). Se createdAt faltar, mantém ordem.
    images.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

    // se o index está fora do range, resetar para 0
    if (index >= images.length) index = 0;

    renderSlides();
  }, (err) => {
    console.error("Erro ao escutar Firebase:", err);
    statusEl.textContent = "Erro ao carregar dados";
  });

</script>

</body>
</html>
